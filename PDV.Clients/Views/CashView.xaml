<ui:FluentWindow
    x:Class="PDV.Clients.Views.CashView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="Nova Venda"
    Width="1100"
    Height="700"
    ExtendsContentIntoTitleBar="True"
    WindowBackdropType="Mica"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <ui:FluentWindow.Resources>
        <!--  Conversor Padrão de Visibilidade  -->
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <!--  Estilo dos Cartões  -->
        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefaultBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>

        <!--  Estilo Inteligente para o Conteúdo Principal  -->
        <!--  Isso substitui a necessidade do InverseBoolConverter  -->
        <Style x:Key="MainContentGridStyle" TargetType="Grid">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsOpenCashModalVisible}" Value="True">
                    <Setter Property="IsEnabled" Value="False" />
                    <Setter Property="Opacity" Value="0.4" />
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="4" />
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </ui:FluentWindow.Resources>

    <!--  Grid Raiz  -->
    <Grid>

        <!--  ==========================================  -->
        <!--  CONTEÚDO PRINCIPAL DA TELA DE VENDAS  -->
        <!--  ==========================================  -->
        <Grid Margin="24" Style="{StaticResource MainContentGridStyle}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,24">
                <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                    <ui:Button
                        Margin="0,0,12,0"
                        Appearance="Secondary"
                        Command="{Binding BackCommand}"
                        Icon="{ui:SymbolIcon ArrowLeft24}"
                        ToolTip="Voltar para Dashboard" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="24"
                        FontWeight="SemiBold"
                        Text="Nova Venda" />
                </StackPanel>

                <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                    <ui:Button
                        Margin="0,0,12,0"
                        Appearance="Secondary"
                        Command="{Binding CloseCashCommand}"
                        Icon="{ui:SymbolIcon LockClosed24}"
                        ToolTip="Fechar Sessão do Caixa" />

                    <ui:Button Appearance="Danger" Command="{Binding CancelSaleCommand}">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Margin="0,0,8,0" Symbol="Delete24" />
                            <TextBlock Text="Cancelar Venda" />
                        </StackPanel>
                    </ui:Button>
                </StackPanel>
            </Grid>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2.5*" />
                    <ColumnDefinition Width="1*" />
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0" Margin="0,0,24,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border Style="{StaticResource CardBorderStyle}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <Grid>
                                <ui:AutoSuggestBox
                                    Grid.Column="0"
                                    Margin="0,0,15,0"
                                    DisplayMemberPath="Name"
                                    ItemsSource="{Binding ProductSuggestions}"
                                    OriginalItemsSource="{Binding ProductSuggestions}"
                                    PlaceholderText="Busque nome ou SKU..."
                                    Text="{Binding SearchProductText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <b:Interaction.Triggers>
                                        <b:EventTrigger EventName="SuggestionChosen">
                                            <b:InvokeCommandAction Command="{Binding SelectProductCommand}" PassEventArgsToCommand="True" />
                                        </b:EventTrigger>
                                    </b:Interaction.Triggers>
                                </ui:AutoSuggestBox>
                            </Grid>

                            <ui:TextBox
                                Grid.Column="1"
                                Width="80"
                                Margin="0,0,12,0"
                                PlaceholderText="Qtd"
                                Text="{Binding QuantityText}"
                                TextAlignment="Center" />

                            <ui:Button
                                Grid.Column="2"
                                Appearance="Primary"
                                Command="{Binding AddProductCommand}"
                                Content="Adicionar"
                                Icon="{ui:SymbolIcon Add24}" />
                        </Grid>
                    </Border>

                    <ui:DataGrid
                        x:Name="CartDataGrid"
                        Grid.Row="1"
                        AutoGenerateColumns="False"
                        ItemsSource="{Binding CartItems}"
                        VerticalScrollBarVisibility="Auto">
                        <ui:DataGrid.Columns>
                            <DataGridTextColumn
                                Width="0.5*"
                                Binding="{Binding ProductId}"
                                Header="Cód." />
                            <DataGridTextColumn
                                Width="2*"
                                Binding="{Binding ProductName}"
                                Header="Produto" />
                            <DataGridTextColumn
                                Width="0.7*"
                                Binding="{Binding UnitPrice, StringFormat=C}"
                                Header="Preço" />
                            <DataGridTextColumn
                                Width="0.5*"
                                Binding="{Binding Quantity}"
                                Header="Qtd" />
                            <DataGridTextColumn
                                Width="0.7*"
                                Binding="{Binding TotalPrice, StringFormat=C}"
                                FontWeight="SemiBold"
                                Header="Total" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ui:Button
                                            Appearance="Transparent"
                                            Command="{Binding DataContext.RemoveItemCommand, ElementName=CartDataGrid}"
                                            CommandParameter="{Binding}"
                                            Icon="{ui:SymbolIcon Delete24}"
                                            ToolTip="Remover" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </ui:DataGrid.Columns>
                    </ui:DataGrid>
                </Grid>

                <StackPanel Grid.Column="1">
                    <Border Padding="16" Style="{StaticResource CardBorderStyle}">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,8"
                                FontWeight="SemiBold"
                                Text="Cliente" />

                            <ui:AutoSuggestBox
                                DisplayMemberPath="Name"
                                ItemsSource="{Binding CustomerSuggestions}"
                                OriginalItemsSource="{Binding CustomerSuggestions}"
                                PlaceholderText="Busque nome ou CPF..."
                                Text="{Binding CustomerSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <b:Interaction.Triggers>
                                    <b:EventTrigger EventName="SuggestionChosen">
                                        <b:InvokeCommandAction Command="{Binding SelectCustomerCommand}" PassEventArgsToCommand="True" />
                                    </b:EventTrigger>
                                </b:Interaction.Triggers>
                            </ui:AutoSuggestBox>

                            <TextBlock
                                Margin="0,8,0,0"
                                FontSize="12"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                Text="{Binding SelectedCustomerName, FallbackValue='Cliente não identificado'}" />
                        </StackPanel>
                    </Border>

                    <Border Padding="20" Style="{StaticResource CardBorderStyle}">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,16"
                                FontSize="18"
                                FontWeight="SemiBold"
                                Text="Resumo" />

                            <Grid Margin="0,0,0,8">
                                <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="Subtotal" />
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontWeight="SemiBold"
                                    Text="{Binding SubTotal, StringFormat=C}" />
                            </Grid>

                            <Grid Margin="0,0,0,16">
                                <TextBlock
                                    VerticalAlignment="Center"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Desconto" />
                                <ui:TextBox
                                    Width="100"
                                    HorizontalAlignment="Right"
                                    PlaceholderText="R$ 0,00"
                                    Text="{Binding DiscountValue}"
                                    TextAlignment="Right" />
                            </Grid>

                            <Separator Margin="0,0,0,16" />

                            <StackPanel Margin="0,0,0,24" HorizontalAlignment="Right">
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontSize="14"
                                    Text="TOTAL" />
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontSize="36"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                                    Text="{Binding FinalTotal, StringFormat=C}" />
                            </StackPanel>

                            <TextBlock
                                Margin="0,0,0,8"
                                FontWeight="SemiBold"
                                Text="Pagamento" />

                            <ComboBox
                                Margin="0,0,0,24"
                                HorizontalAlignment="Stretch"
                                SelectedValue="{Binding SelectedPaymentMethod}">
                                <sys:String>Dinheiro</sys:String>
                                <sys:String>Cartão de Crédito</sys:String>
                                <sys:String>Cartão de Débito</sys:String>
                                <sys:String>PIX</sys:String>
                            </ComboBox>

                            <ui:Button
                                Height="45"
                                HorizontalAlignment="Stretch"
                                Appearance="Primary"
                                Command="{Binding FinalizeSaleCommand}">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Margin="0,0,8,0" Symbol="Checkmark24" />
                                    <TextBlock FontSize="16" Text="Finalizar Venda" />
                                </StackPanel>
                            </ui:Button>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </Grid>

        <Grid Background="#99000000" Visibility="{Binding IsOpenCashModalVisible, Converter={StaticResource BoolToVis}}">

            <Border
                Width="420"
                Padding="32"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="12">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="20"
                        Opacity="0.4"
                        ShadowDepth="0" />
                </Border.Effect>

                <StackPanel>

                    <ui:Button
                        Margin="0,0,12,0"
                        HorizontalAlignment="Left"
                        Appearance="Secondary"
                        Command="{Binding BackCommand}"
                        Content="Voltar para Dashboard"
                        Icon="{ui:SymbolIcon ArrowLeft24}" />

                    <ui:SymbolIcon
                        Margin="0,16,0,16"
                        FontSize="48"
                        Foreground="{DynamicResource SystemFillColorCautionBrush}"
                        Symbol="Money24" />

                    <TextBlock
                        Margin="0,0,0,8"
                        HorizontalAlignment="Center"
                        FontSize="24"
                        FontWeight="Bold"
                        Text="Abertura de Caixa" />

                    <TextBlock
                        Margin="0,0,0,24"
                        HorizontalAlignment="Center"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="O caixa está fechado. Informe o fundo de troco para iniciar."
                        TextAlignment="Center"
                        TextWrapping="Wrap" />

                    <TextBlock
                        Margin="0,0,0,6"
                        FontWeight="SemiBold"
                        Text="Valor Inicial (R$)" />

                    <ui:TextBox
                        Margin="0,0,0,24"
                        FontSize="18"
                        PlaceholderText="0,00"
                        Text="{Binding OpeningAmountText, UpdateSourceTrigger=PropertyChanged}"
                        TextAlignment="Center" />

                    <ui:Button
                        HorizontalAlignment="Stretch"
                        Appearance="Primary"
                        Command="{Binding OpenCashCommand}"
                        Content="Abrir Caixa e Iniciar Vendas"
                        Icon="{ui:SymbolIcon Checkmark24}" />
                </StackPanel>
            </Border>
        </Grid>
        <ContentPresenter x:Name="RootContentDialogPresenter" Grid.RowSpan="2" />
    </Grid>
</ui:FluentWindow>