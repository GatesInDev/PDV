<ui:FluentWindow
    x:Class="PDV.Clients.Views.CashView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="Nova Venda"
    Width="1400"
    Height="900"
    MinWidth="1000"
    MinHeight="700"
    ExtendsContentIntoTitleBar="True"
    WindowBackdropType="Mica"
    WindowStartupLocation="CenterScreen"
    WindowState="Maximized"
    mc:Ignorable="d">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource CardStrokeColorDefaultBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>

        <Style x:Key="MainContentGridStyle" TargetType="Grid">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsOpenCashModalVisible}" Value="True">
                    <Setter Property="IsEnabled" Value="False" />
                    <Setter Property="Opacity" Value="0.4" />
                    <Setter Property="Effect">
                        <Setter.Value>
                            <BlurEffect Radius="4" />
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid Margin="32" Style="{StaticResource MainContentGridStyle}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,24">
                <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                    <ui:Button
                        Margin="0,0,12,0"
                        Padding="12,8"
                        Appearance="Secondary"
                        Command="{Binding BackCommand}"
                        Content="{Binding BackButtonText}"
                        Icon="{ui:SymbolIcon ArrowLeft24}"
                        ToolTip="Voltar para Dashboard ou Fechar Aplicação" />
                    <ui:SymbolIcon
                        Margin="0,0,12,0"
                        FontSize="32"
                        Symbol="ReceiptBag24" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="28"
                        FontWeight="SemiBold"
                        Text="Nova Venda" />
                </StackPanel>

                <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                    <ui:Button
                        Margin="0,0,12,0"
                        Padding="12,8"
                        Appearance="Secondary"
                        Command="{Binding CloseCashCommand}"
                        Content="Fechar Caixa"
                        Icon="{ui:SymbolIcon LockClosed24}"
                        ToolTip="Fechar Sessão do Caixa" />

                    <ui:Button
                        Padding="12,8"
                        Appearance="Danger"
                        Command="{Binding CancelSaleCommand}">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Margin="0,0,8,0" Symbol="Delete24" />
                            <TextBlock Text="Cancelar Venda" />
                        </StackPanel>
                    </ui:Button>
                </StackPanel>
            </Grid>

            <TextBlock
                Grid.Row="0"
                Margin="0,0,0,8"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Foreground="#FF5555"
                Text="{Binding ErrorMessage}"
                TextWrapping="Wrap">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <Trigger Property="Text" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </Trigger>
                            <Trigger Property="Text" Value="">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="16" />
                    <ColumnDefinition Width="480" />
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <ui:Card
                        Grid.Row="0"
                        Margin="0,0,0,16"
                        Padding="20">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <ui:AutoSuggestBox
                                Grid.Column="0"
                                Margin="0,0,16,0"
                                DisplayMemberPath="Name"
                                ItemsSource="{Binding ProductSuggestions}"
                                OriginalItemsSource="{Binding ProductSuggestions}"
                                PlaceholderText="Busque nome ou SKU..."
                                Text="{Binding SearchProductText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <b:Interaction.Triggers>
                                    <b:EventTrigger EventName="SuggestionChosen">
                                        <b:InvokeCommandAction Command="{Binding SelectProductCommand}" PassEventArgsToCommand="True" />
                                    </b:EventTrigger>
                                </b:Interaction.Triggers>
                            </ui:AutoSuggestBox>

                            <ui:TextBox
                                Grid.Column="1"
                                Width="100"
                                Margin="0,0,12,0"
                                PlaceholderText="Qtd"
                                Text="{Binding QuantityText}"
                                TextAlignment="Center" />

                            <ui:Button
                                Grid.Column="2"
                                Padding="16,8"
                                Appearance="Primary"
                                Command="{Binding AddProductCommand}"
                                Content="Adicionar"
                                Icon="{ui:SymbolIcon Add24}" />
                        </Grid>
                    </ui:Card>

                    <ui:Card
                        Grid.Row="1"
                        Padding="0"
                        VerticalAlignment="Top">
                        <ui:DataGrid
                            x:Name="CartDataGrid"
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            CanUserResizeColumns="False"
                            CanUserResizeRows="False"
                            CanUserSortColumns="False"
                            IsReadOnly="True"
                            ItemsSource="{Binding CartItems}"
                            VerticalScrollBarVisibility="Auto">
                            <ui:DataGrid.Columns>
                                <DataGridTextColumn
                                    Width="1.0*"
                                    Binding="{Binding ProductId}"
                                    Header="Cód." />
                                <DataGridTextColumn
                                    Width="*"
                                    Binding="{Binding ProductName}"
                                    Header="Produto" />
                                <DataGridTextColumn
                                    Width="0.6*"
                                    Binding="{Binding UnitPrice, StringFormat=C}"
                                    Header="Preço" />
                                <DataGridTextColumn
                                    Width="0.6*"
                                    Binding="{Binding Quantity}"
                                    Header="Qtd" />
                                <DataGridTextColumn
                                    Width="0.6*"
                                    Binding="{Binding TotalPrice, StringFormat=C}"
                                    FontWeight="SemiBold"
                                    Header="Total" />
                                <DataGridTemplateColumn Width="0.2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ui:Button
                                                Appearance="Transparent"
                                                Command="{Binding DataContext.RemoveItemCommand, ElementName=CartDataGrid}"
                                                CommandParameter="{Binding}"
                                                Icon="{ui:SymbolIcon Delete24}"
                                                ToolTip="Remover" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </ui:DataGrid.Columns>
                        </ui:DataGrid>
                    </ui:Card>
                </Grid>

                <StackPanel Grid.Column="2">
                    <ui:Card Margin="0,0,0,16" Padding="20">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,12"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Cliente" />

                            <ui:AutoSuggestBox
                                DisplayMemberPath="Name"
                                ItemsSource="{Binding CustomerSuggestions}"
                                OriginalItemsSource="{Binding CustomerSuggestions}"
                                PlaceholderText="Busque por nome..."
                                Text="{Binding CustomerSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                <b:Interaction.Triggers>
                                    <b:EventTrigger EventName="SuggestionChosen">
                                        <b:InvokeCommandAction Command="{Binding SelectCustomerCommand}" PassEventArgsToCommand="True" />
                                    </b:EventTrigger>
                                </b:Interaction.Triggers>
                            </ui:AutoSuggestBox>
                        </StackPanel>
                    </ui:Card>

                    <ui:Card Padding="20">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,20"
                                FontSize="18"
                                FontWeight="SemiBold"
                                Text="Resumo" />

                            <Grid Margin="0,0,0,12">
                                <TextBlock Foreground="#999999" Text="Subtotal" />
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontWeight="SemiBold"
                                    Text="{Binding SubTotal, StringFormat=C}" />
                            </Grid>

                            <Grid Margin="0,0,0,16">
                                <TextBlock
                                    VerticalAlignment="Center"
                                    Foreground="#999999"
                                    Text="Desconto" />
                                <ui:TextBox
                                    Width="120"
                                    HorizontalAlignment="Right"
                                    Text="{Binding DiscountValue, UpdateSourceTrigger=PropertyChanged}"
                                    TextAlignment="Right"
                                    TextChanged="OnCurrencyTextChanged" />
                            </Grid>

                            <Separator Margin="0,0,0,16" />

                            <StackPanel Margin="0,0,0,24" HorizontalAlignment="Right">
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontSize="13"
                                    Foreground="#999999"
                                    Text="TOTAL" />
                                <TextBlock
                                    HorizontalAlignment="Right"
                                    FontSize="40"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                                    Text="{Binding FinalTotal, StringFormat=C}" />
                            </StackPanel>

                            <TextBlock
                                Margin="0,0,0,12"
                                FontWeight="SemiBold"
                                Text="Forma de Pagamento" />

                            <ComboBox
                                Margin="0,0,0,20"
                                HorizontalAlignment="Stretch"
                                SelectedValue="{Binding SelectedPaymentMethod}">
                                <sys:String>Dinheiro</sys:String>
                                <sys:String>Cartão de Crédito</sys:String>
                                <sys:String>Cartão de Débito</sys:String>
                                <sys:String>PIX</sys:String>
                            </ComboBox>

                            <ui:Button
                                Height="50"
                                Margin="0,0,0,8"
                                Padding="0,12"
                                HorizontalAlignment="Stretch"
                                Appearance="Primary"
                                Command="{Binding FinalizeSaleCommand}">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Margin="0,0,8,0" Symbol="Checkmark24" />
                                    <TextBlock FontSize="16" Text="Finalizar Venda" />
                                </StackPanel>
                            </ui:Button>
                        </StackPanel>
                    </ui:Card>
                </StackPanel>
            </Grid>
        </Grid>

        <Grid Background="#99000000" Visibility="{Binding IsOpenCashModalVisible, Converter={StaticResource BoolToVis}}">
            <Border
                Width="480"
                Padding="32"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="12">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="20"
                        Opacity="0.4"
                        ShadowDepth="0" />
                </Border.Effect>

                <StackPanel>
                    <ui:SymbolIcon
                        Margin="0,16,0,20"
                        FontSize="56"
                        Foreground="{DynamicResource SystemFillColorCautionBrush}"
                        Symbol="Money24" />

                    <TextBlock
                        Margin="0,0,0,12"
                        HorizontalAlignment="Center"
                        FontSize="24"
                        FontWeight="Bold"
                        Text="Abertura de Caixa" />

                    <TextBlock
                        Margin="0,0,0,24"
                        HorizontalAlignment="Center"
                        Foreground="#999999"
                        Text="O caixa está fechado. Informe o fundo de troco para iniciar."
                        TextAlignment="Center"
                        TextWrapping="Wrap" />

                    <TextBlock
                        Margin="0,0,0,8"
                        FontWeight="SemiBold"
                        Text="Valor Inicial (R$)" />

                    <ui:TextBox
                        Margin="0,0,0,24"
                        FontSize="18"
                        PlaceholderText="0,00"
                        Text="{Binding OpeningAmountText, UpdateSourceTrigger=PropertyChanged}"
                        TextAlignment="Center"
                        TextChanged="OnCurrencyTextChanged" />

                    <ui:Button
                        Height="45"
                        HorizontalAlignment="Stretch"
                        Appearance="Primary"
                        Command="{Binding OpenCashCommand}"
                        Content="{Binding OpenCashButtonText}"
                        Icon="{ui:SymbolIcon Checkmark24}" />

                    <ui:Button
                        Height="45"
                        Margin="0,12,0,0"
                        HorizontalAlignment="Stretch"
                        Appearance="Secondary"
                        Command="{Binding BackCommand}"
                        Content="{Binding BackButtonText}"
                        Icon="{ui:SymbolIcon ArrowLeft24}" />
                </StackPanel>
            </Border>
        </Grid>
        <ContentPresenter x:Name="RootContentDialogPresenter" Grid.RowSpan="2" />
    </Grid>
</ui:FluentWindow>